---
layout: post
title: The importance of TDD
subtitle: Javascript Test Framwork, JEST
comments: true
tags: [NodeJS, Express, Jest, axios]
---

Test Driven Developent, ì¦‰ í…ŒìŠ¤íŠ¸ ì£¼ë„ ê°œë°œì€ í•„ìˆ˜ ì‚¬í•­ì€ ì•„ë‹ˆì§€ë§Œ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•¨ìœ¼ë¡œì¨ ì„±ê³µ ë° ì‹¤íŒ¨ ì¼€ì´ìŠ¤ë¥¼ ëª¨ë‘ ê²€ì¦í•˜ì—¬ ìš°ë¦¬ì˜ ì–´í”Œë¦¬ì¼€ì´ì…˜ì´ ì›í•˜ëŠ” ëŒ€ë¡œ ë™ì‘í•  ê²ƒì´ë¼ëŠ” ìì‹ ê°ì„ ê°€ì§ˆ ìˆ˜ ìˆê²Œ í•´ì¤€ë‹¤. ì‹¤íŒ¨í•˜ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ë¨¼ì € ì‘ì„±í•´ë‘ê³  ì‹¤ì œë¡œ ê°œë°œí•˜ë©´ì„œ ì´ í…ŒìŠ¤íŠ¸ì— í†µê³¼í•  ìˆ˜ ìˆëŠ” ë°©í–¥ìœ¼ë¡œ ì½”ë“œë¥¼ ì‘ì„±í•˜ëŠ” ì‘ì—…ì„ ë°˜ë³µí•œë‹¤. ì´ë ‡ê²Œ í•´ì„œ ëª¨ë“  í…ŒìŠ¤íŠ¸ë¥¼ í†µê³¼í•˜ë©´ ë¦¬íŒ©í† ë§ì„ ê±°ì³ ì´í›„ì—ë„ í…ŒìŠ¤íŠ¸ì— ì„±ê³µí•  ìˆ˜ ìˆë„ë¡ ë§Œë“ ë‹¤. í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ í•¨ê»˜ ë ˆí¬ì— mergeí•˜ë©´ ê°œë°œìë“¤ ê°„ì˜ í…ŒìŠ¤íŠ¸ ì»¤ë²„ë¦¬ì§€ë¥¼ ì‹¤ì‹œê°„ìœ¼ë¡œ í™•ì¸í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì— ë¬¸ì„œí™”ì˜ íš¨ê³¼ë„ ê°€ì§„ë‹¤. ì´ë²ˆ í”„ë¡œì íŠ¸ì—ì„œëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ì˜ í…ŒìŠ¤íŠ¸ í”„ë ˆì„ì›Œí¬ì¸ JEST ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì‚¬ìš©í•˜ì˜€ë‹¤. [API ë¬¸ì„œ](https://jestjs.io/docs/api)ì— ì„¤ëª…ì´ ì˜ ë‚˜ì™€ìˆìœ¼ë©° ë³„ë„ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ë§Œ ì¶”ê°€í•˜ë©´ Typescript í™˜ê²½ì—ì„œë„ ì§€ì›ì´ ëœë‹¤ëŠ” ì ì—ì„œ ë§¤ìš° í¸ë¦¬í–ˆë‹¤. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•Œì—ëŠ” JESTê°€ ì œê³µí•˜ëŠ” ê¸°ëŠ¥ ì¤‘ ëª¨ë“ˆì˜ ì „ì²´ í˜¹ì€ ì¼ë¶€ë¥¼ mocking í•  ìˆ˜ë„ ìˆë‹¤. í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•  ë•Œ ì–´ë–¤ í•œ ëª¨ë“ˆì´ ë‚´ë¶€ì ìœ¼ë¡œ ì‚¬ìš©í•˜ëŠ”, ì¦‰ import í•´ì˜¤ëŠ” ì˜ì¡´ì„±ì´ ìˆë‹¤ë©´ ê·¸ ì™¸ë¶€ ëª¨ë“ˆ ì „ì²´ í˜¹ì€ ë¶€ë¶„ì„ í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ mockí•´ì£¼ëŠ” ê²ƒì¸ë°(ì‹¤ì œë¡œ ë‚´ê°€ ì²˜ìŒì— ì‚¬ìš©í•œ ë°©ë²•ì´ë‹¤.) ì´ëŠ” ëª¨ë“ˆ ê°„ ì˜ì¡´ì„±ì˜ decouplingì„ ì €í•´í•˜ê³  ë¶€ë¶„ì ìœ¼ë¡œë§Œ ëª¨ë“ˆì˜ ê¸°ëŠ¥ë“¤ì„ mocking í•´ì•¼í•  ë•Œì—ëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ êµ¬í˜„í•˜ëŠ” ê²ƒ ì—­ì‹œ ì‰½ì§€ ì•Šì•˜ë‹¤. ë”°ë¼ì„œ ëŒ€ì•ˆì ìœ¼ë¡œ Stubì˜ ë°©ì‹ì„ ì±„íƒí•´ ë¦¬íŒ©í† ë§í•œ ì½”ë“œë¥¼ ì¶”ê°€ì ìœ¼ë¡œ ì²¨ë¶€í•˜ì—¬ ì–´ë–»ê²Œ ë‚˜ìœ ì½”ë“œì˜ ì˜ˆì œë¥¼ ë°”ê¾¸ì—ˆëŠ”ì§€ì˜ ê³¼ì •ì„ ë³´ì—¬ì¤„ ê²ƒì´ë‹¤. Stubì€ ê°œë°œ ì½”ë“œì—ì„œ ì™¸ë¶€ ëª¨ë“ˆì„ importí•˜ëŠ” ê²ƒì´ ì•„ë‹Œ ìƒì„±ì í•¨ìˆ˜ë¥¼ í†µí•´ ì£¼ì…ë°›ëŠ” ê²ƒì´ê³  í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œëŠ” í…ŒìŠ¤íŠ¸ ìš©ìœ¼ë¡œ ë³„ë„ë¡œ ë§Œë“¤ì–´ ë†“ì€ í´ë˜ìŠ¤ì˜ ê°ì²´ë¥¼ ì£¼ì…ë°›ê±°ë‚˜ ë¹ˆ objectë¥¼ ì£¼ì…ë°›ì•„ í•„ìš”í•  ë•Œë§ˆë‹¤ ë‚´ë¶€ì ìœ¼ë¡œ í”„ë¡œí¼í‹° ë©”ì†Œë“œë¥¼ ì •ì˜í•´ ì£¼ëŠ” ê²ƒì´ë‹¤. í›„ìëŠ” ìˆœìˆ˜ ìë°”ìŠ¤í¬ë¦½íŠ¸ì—ì„œë§Œ ê°€ëŠ¥í•œ ë°©ë²•ìœ¼ë¡œ ë‚˜ëŠ” í…ŒìŠ¤íŠ¸ í´ë”ì— ë”°ë¡œ Stub í´ë˜ìŠ¤ë¥¼ ìƒì„±í•´ì£¼ì—ˆë‹¤. ê²°êµ­ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ë‹¤ ë³´ë©´ ëª¨ë“ˆì˜ ì˜ì¡´ì„±ì„ ê³ ë ¤í•˜ê²Œ ë˜ì–´ ê°œë°œ ì½”ë“œì˜ í€„ë¦¬í‹°ë¥¼ í–¥ìƒì‹œí‚¬ ìˆ˜ ìˆë‹¤.

## Essential things to do before we start

íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ë¡œ Jest ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´ìš©í•´ ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì™€ í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ í•˜ê¸° ìœ„í•´ì„œ ì¶”ê°€í•´ì•¼í•˜ëŠ” ì™¸ë¶€ ì˜ì¡´ì„±ë“¤ì€ ë‹¤ìŒê³¼ ê°™ë‹¤.

- jest
- ts-jest, @types/jest
- node-mocks-http (ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•Œ ê°€ì§œ http ìš”ì²­ ë° ì‘ë‹µ ê°ì²´ë¥¼ ìƒì„±í•  ìˆ˜ ìˆê²Œ í•´ì¤Œ)
- faker@5.5.3 (ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•Œ ê°€ì§œ ìœ ì €ì˜ ì •ë³´ ë“± mockingí•  ë•Œ ìœ ìš©í•œ ë¼ì´ë¸ŒëŸ¬ë¦¬, í˜„ì¬ ë²„ì „ì€ ì˜ ì‘ë™í•˜ì§€ ì•Šì•„ ì´ì „ ë²„ì „ì„ ì„¤ì¹˜í–ˆìŒ)
- axios(í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•Œ ì§ì ‘ ì„œë²„ì—ë‹¤ê°€ http ìš”ì²­ì„ í•˜ì—¬ í”„ë¡œë¯¸ìŠ¤ í˜•íƒœì˜ ì‘ë‹µì„ ë°›ì•„ì˜¬ ìˆ˜ ìˆê²Œ í•´ì¤Œ)

ë˜í•œ jestëŠ” es6ì˜ ëª¨ë“ˆê³¼ ì˜ ë™ì‘í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— commonjsë¡œ ë³€í™˜í•´ì£¼ëŠ” ë°”ë²¨ í”ŒëŸ¬ê·¸ì¸ì„ ì„¤ì¹˜í•´ ì¤€ í›„ í”„ë¡œì íŠ¸ ìµœìƒìœ„ í´ë” ë‚´ë¶€ì˜ .babelrc íŒŒì¼ì— ì•„ë˜ì˜ ì½”ë“œë¥¼ ì‘ì„±í•´ì£¼ì–´ì•¼ í•œë‹¤.

**npm i --save-dev @babel/plugin-transform-modules-commonjs**

```json
{
	"env": {
		"test": {
			"plugins": ["@babel/plugin-transform-modules-commonjs"]
		}
	}
}
```

íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ë¡œ ì •ì˜ëœ ëª¨ë“  testíŒŒì¼ ë‚´ë¶€ì—ì„œ ëª¨ë“ˆì„ importí•  ë•Œì—ëŠ” extensionì— .jsë¥¼ ë¶™ì¼ ìˆ˜ ì—†ë‹¤.
extensionì„ ìƒëµí•˜ê³  npm startë¥¼ í•˜ë©´ es6 ëª¨ë“ˆë¡œ ì¸ì‹ë˜ëŠ” ìë°”ìŠ¤í¬ë¦½íŠ¸ íŒŒì¼ë¡œ ì»´íŒŒì¼ ëœ í›„ ì„œë²„ë¥¼ ì‹¤í–‰ì‹œí‚¤ì— ì˜¤ë¥˜ê°€ ë°œìƒí•˜ëŠ”ë°, commonjs ëª¨ë“ˆê³¼ ë‹¬ë¦¬ es6 ëª¨ë“ˆì€ extensionì´ ë¹ ì§€ë©´ ì•ˆë˜ê¸° ë•Œë¬¸ì´ë‹¤. ë”°ë¼ì„œ jest.config.mjsì—ì„œ ë‹¤ìŒê³¼ ê°™ì€ ì¶”ê°€ì ì¸ ì„¤ì •ì„ í•´ì¤˜ì•¼ í•œë‹¤. ì°¸ê³ ë¡œ jest --init ëª…ë ¹ì–´ë¥¼ ì…ë ¥í•˜ë©´ jest.config.mjs íŒŒì¼ì„ ìƒì„±í•  ìˆ˜ ìˆë‹¤.

```json
{
	"extensionsToTreatAsEsm": [".ts"],
	"moduleNameMapper": {
		"^(\\.{1,2}/.*)\\.js$": "$1"
	},
	"transform": {
		"^.+\\.tsx?$": [
			"ts-jest",
			{
				"useESM": true
			}
		]
	}
}
```

ê·¸ ë‹¤ìŒì€ í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ì„ ë”°ë¡œ ë§Œë“¤ì–´ì£¼ëŠ” ê²ƒì´ë‹¤. **.env.test** íŒŒì¼ì— process.envì—ì„œ ë¡œë“œí•  keyì™€ valueì˜ ìŒë“¤ì„ ëª¨ë‘ ì ì–´ì£¼ê³  jest.config.mjs íŒŒì¼ì˜ setupFilesì˜ ë°°ì—´ì— 'dotenv/config'ë¥¼ ì¶”ê°€í•´ì¤€ë‹¤. ì´ëŠ” ê°ê°ì˜ í…ŒìŠ¤íŠ¸ ì´ì „ì˜ dotenv ëª¨ë“ˆì˜ config ë©”ì†Œë“œë¥¼ ì‹¤í–‰í•˜ê²Œ í•´ì¤€ë‹¤. ê·¸ë¦¬ê³  package.jsonì˜ npm ëª…ë ¹ì–´ ì •ì˜ ë¶€ë¶„ì—ì„œ í…ŒìŠ¤íŠ¸ ì¢…ë¥˜ ë³„ë¡œ í…ŒìŠ¤íŠ¸ìš© í™˜ê²½ ë³€ìˆ˜ íŒŒì¼ ìœ„ì¹˜ë¥¼ ëª…ì‹œí•´ì£¼ëŠ” DOTENV_CONFIG_PATH ì˜µì…˜ì„ ì„¤ì •í•´ì¤€ë‹¤. ìœˆë„ìš°ì˜ ê²½ìš° dev ëª¨ë“œë¡œ cross-envë¥¼ ì„¤ì¹˜í•œ í›„ ëª…ë ¹ì–´ ì• ë¶€ë¶„ì— ì¶”ê°€í•´ì£¼ì–´ì•¼ ì •ìƒì ìœ¼ë¡œ ì‘ë™í•œë‹¤.

```json
"scripts": {
    "test": "cross-env DOTENV_CONFIG_PATH=./.env.test jest --watchAll --verbose --globalTeardown=./src/tests/global_teardown.ts",
    "test:unit": "cross-env DOTENV_CONFIG_PATH=./.env.test jest --watchAll --verbose --testPathIgnorePatterns /src/tests /dist",
    "test:integration": "cross-env DOTENV_CONFIG_PATH=./.env.test jest --watchAll --verbose --testPathPattern=/src/tests --globalTeardown=./src/tests/global_teardown.ts",
    "start": "concurrently \"tsc -w\" nodemon dist/index"
  }
```

ì—¬ê¸°ì„œ ë‚´ê°€ ì‚¬ìš©í•œ ëª‡ ê°€ì§€ ì˜µì…˜ë“¤ì— ëŒ€í•´ ì‚´í´ë³´ì. --watchAllì€ í…ŒìŠ¤íŠ¸ íŒŒì¼ì— ë³€ê²½ì‚¬í•­ì´ ìƒê¸¸ ë•Œë§ˆë‹¤ ëª¨ë“  í…ŒìŠ¤íŠ¸ íŒŒì¼ì„ ë‹¤ì‹œ ì¬ì‹¤í–‰í•˜ë„ë¡ í•´ì¤€ë‹¤. --verboseëŠ” ì‹¤í–‰ëœ í…ŒìŠ¤íŠ¸ íŒŒì¼ë³„ë¡œ ê³„ì¸µì— ë”°ë¼ ê°œë³„ì ì¸ í…ŒìŠ¤íŠ¸ì˜ ê²°ê³¼(describe í˜¹ì€ testì˜ ì²«ë²ˆì§¸ ì¸ìë¡œ ë„˜ê²¨ì£¼ëŠ” string ê°’)ë“¤ì„ ì¶œë ¥í•´ì¤€ë‹¤. --globalTeardownì€ ëª¨ë“  í…ŒìŠ¤íŠ¸ì˜ ì‹¤í–‰ì„ ë§ˆì¹œ í›„ ë°ì´í„°ë² ì´ìŠ¤ ì •ë¦¬ ì‘ì—…ì„ í•´ì£¼ëŠ” ë“±ì˜ ì‘ì—…ì„ ì‹¤í–‰í•  íŒŒì¼ì„ ì •ì˜í•´ì¤€ë‹¤. ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” dbì— ì§ì ‘ ì ‘ê·¼í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— tear down ì‘ì—…ì„ í•´ ì¤„ í•„ìš”ê°€ ì—†ë‹¤.

## Unit Test

ìœ ë‹›í…ŒìŠ¤íŠ¸ëŠ” í•˜ë‚˜ì˜ í•¨ìˆ˜, ëª¨ë“ˆ í˜¹ì€ í´ë˜ìŠ¤ê°€ ì›í•˜ëŠ” ëŒ€ë¡œ ë™ì‘í•˜ëŠ” ì§€ë¥¼ ê²€ì¦í•˜ëŠ” ê²ƒì´ë‹¤. ì˜ˆë¥¼ ë“¤ì–´, User API ìš”ì²­ì„ ì²˜ë¦¬í•˜ëŠ” ê°ê°ì˜ ì„œë¹„ìŠ¤ ë³„ controllerì˜ ì‹¤í–‰ ê²°ê³¼ì— ëŒ€í•´ ì„±ê³µê³¼ ì‹¤íŒ¨ ì¼€ì´ìŠ¤ ëª¨ë‘ í…ŒìŠ¤íŠ¸ ì½”ë“œë¥¼ ì‘ì„±í•  ìˆ˜ ìˆë‹¤.

ë¨¼ì € í…ŒìŠ¤íŠ¸ì˜ ëŒ€ìƒì´ ë˜ëŠ” user.ts íŒŒì¼ì˜ ì½”ë“œë¥¼ ì‚´í´ë³´ì.

**/src/controller/user.ts**

```javascript
import { Request, Response, NextFunction } from 'express';
import bcrypt from 'bcrypt';
import jwt from 'jsonwebtoken';
import * as UserRepository from '../data/user.js';
import * as BugsRepository from '../data/bugs.js';
import * as CompanyRepository from '../data/companies.js';
import * as ProductRepository from '../data/products.js';
import { config } from '../config.js';
import { UserRegistration, UserLogin, ProductItem } from '../types/index.js';

export const createUser = async (
	req: Request,
	res: Response,
	next: NextFunction
) => {
	const { userName, password } = req.body as UserRegistration;
	const user = await UserRepository.findUserByName(userName);
	if (user) {
		return res.sendStatus(409);
	}

	const hashed = await bcrypt.hash(
		password,
		parseInt(config.bcrypt.saltsRound)
	);
	const userId = await UserRepository.createUser({
		...req.body,
		password: hashed,
	});

	const token = createJWT(userId);

	res.status(201).json({
		token,
		userName,
	});
}

export const login = async (req: Request, res: Response, next: NextFunction) => {
	const { userName, password } = req.body as UserLogin;
	const user = await UserRepository.findUserByName(userName);
	if (!user) return res.sendStatus(401);

	const match = await bcrypt.compare(password, user.password);
	if (!match) return res.sendStatus(401);

	const token = createJWT(user.id);

	res.status(200).json({
		token,
		userName,
	});
}

export async function remove(req: Request, res: Response, next: NextFunction) {
	await UserRepository.deleteUser(req.userId!);
	res.sendStatus(204);
}

export async function getMyPage(
	req: Request,
	res: Response,
	next: NextFunction
) {
	const { findUserById } = UserRepository;
	const {
		getNumberOfReservationsOfUser,
		getNumberOfInterestedCompaniesOfUser,
		getReservationItemsOfUser,
	} = CompanyRepository;
	const { getSurveyItemsOfUser } = BugsRepository;
	const { getProductItemsOfUser } = ProductRepository;

	const user = await findUserById(req.userId!);
	const accumulatedNumOfUsages = await getNumberOfReservationsOfUser(
		req.userId!
	);
	const numberOfInterestedCompanies =
		await getNumberOfInterestedCompaniesOfUser(req.userId!);
	const surveyList = await getSurveyItemsOfUser(req.userId!);
	const productList = await getProductItemsOfUser(req.userId!);
	const reservationList = await getReservationItemsOfUser(req.userId!);

	let updatedProductList;
	await Promise.all(
		productList.map(async (product) => {
			return updateNumOfInterestedUsers(product);
		})
	).then((result) => (updatedProductList = result));

	const userDetail = {
		...user,
		accumulatedNumOfUsages,
		numberOfInterestedCompanies,
		surveyList,
		updatedProductList,
		reservationList,
	};

	res.status(200).json(userDetail);
}

export function createJWT(userId: number): string {
	return jwt.sign({ userId }, config.jwt.privateKey, {
		expiresIn: config.jwt.expirSecs,
	});
}

async function updateNumOfInterestedUsers(
	product: ProductItem
): Promise<ProductItem> {
	const numOfUsers =
		await ProductRepository.getNumberOfInterestedUsersOfProduct(
			product.productId.toString()
		);
	product.numOfInterestedUsers = numOfUsers;
	return product;
}
```

ìœ„ ì½”ë“œì—ì„œ export í•˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ í•¨ìˆ˜ë“¤ì€ ê°ê° 'íšŒì›ê°€ì…', 'ë¡œê·¸ì¸', 'íšŒì›íƒˆí‡´', 'ë§ˆì´í˜ì´ì§€ ì •ë³´ ë¶ˆëŸ¬ì˜¤ê¸°'ë¥¼ ìœ„í•œ ë¡œì§ê³¼ ê´€ë ¨ë˜ì–´ ìˆë‹¤. ì—¬ê¸°ì„œ ëˆˆ ì—¬ê²¨ ë³¼ ê²ƒì€ ì‚¬ìš©ì, ë²Œë ˆ, íšŒì‚¬, ìƒí’ˆ dbì— ê°ê° ì ‘ê·¼í•˜ëŠ” repositoryì˜ ëª¨ë“ˆë“¤ì— ì˜ì¡´í•˜ê³  ìˆë‹¤ëŠ” ì‚¬ì‹¤ì´ë‹¤. ìœ„ì˜ ì½”ë“œë¥¼ í…ŒìŠ¤íŠ¸ í•˜ê¸° ìœ„í•´ì„œëŠ” í…ŒìŠ¤íŠ¸ ì½”ë“œì—ì„œ ê°ê°ì˜ ëª¨ë“ˆë“¤ì„ jest.mockì„ ì´ìš©í•´ mocking í•´ì•¼ë§Œ ì •ìƒì ìœ¼ë¡œ ê²€ì¦ì„ í•  ìˆ˜ ìˆë‹¤.

**/src/controller/test/user.test.ts**

```javascript
import httpMocks from 'node-mocks-http';
import { faker } from '@faker-js/faker';
import * as bcrypt from 'bcrypt';
import * as userRepository from '../../data/user.js';
import * as companiesRepository from '../../data/companies.js';
import * as productsRepository from '../../data/products.js';
import * as bugsRepository from '../../data/bugs.js';
import { createUser, getMyPage, login, remove } from '../../controller/user.js';

jest.mock('bcrypt');
jest.mock('../../data/user');
jest.mock('../../data/companies');
jest.mock('../../data/products', () => {
	const originalModule = jest.requireActual('../../data/products');

	return {
		__esModule: true,
		...originalModule,
		getNumberOfInterestedUsersOfProduct: jest.fn(async () => '1'),
	};
});
jest.mock('../../data/bugs');

describe('User Controller', () => {
	it('create user', async () => {
		const registrationForm = {
			userName: faker.name.firstName(),
			password: faker.internet.password(),
			name: faker.name.fullName(),
			contactNumbers: faker.phone.number(),
			email: faker.internet.email(),
		};
		const request = httpMocks.createRequest({
			body: registrationForm,
		});
		const response = httpMocks.createResponse();
		const next = jest.fn();

		jest
			.spyOn(userRepository, 'findUserByName')
			.mockImplementation(async () => undefined);

		jest.spyOn(userRepository, 'createUser').mockImplementation(async () => 1);

		await createUser(request, response, next);

		expect(response.statusCode).toBe(201);
		expect(response._getJSONData()).toMatchObject({
			userName: request.body.userName,
		});
		expect(response._getJSONData().token).toBeDefined();
	});

	it('return 409 if user already exists', async () => {
		const userName = faker.name.firstName();
		const password = faker.internet.password();
		const user = {
			id: faker.datatype.number(),
			userName,
			password,
			name: faker.name.fullName(),
			contactNumbers: faker.phone.number(),
			email: faker.internet.email(),
		};
		const registrationForm = {
			userName,
			password,
			name: faker.name.fullName(),
			contactNumbers: faker.phone.number(),
			email: faker.internet.email(),
		};
		const request = httpMocks.createRequest({
			body: registrationForm,
		});
		const response = httpMocks.createResponse();
		const next = jest.fn();

		jest
			.spyOn(userRepository, 'findUserByName')
			.mockImplementation(async () => user);

		await createUser(request, response, next);

		expect(response.statusCode).toBe(409);
	});

	it('succeed to login', async () => {
		const userName = faker.name.firstName();
		const password = faker.internet.password();

		const user = {
			userName,
			password,
			id: faker.datatype.number(),
			name: faker.name.fullName(),
			contactNumbers: faker.phone.number(),
			email: faker.internet.email(),
		};
		const request = httpMocks.createRequest({
			body: {
				userName,
				password,
			},
		});
		const response = httpMocks.createResponse();
		const next = jest.fn();

		jest
			.spyOn(userRepository, 'findUserByName')
			.mockImplementation(async () => user);

		jest.spyOn(bcrypt, 'compare').mockImplementation(async () => true);

		await login(request, response, next);

		expect(response.statusCode).toBe(200);
		expect(response._getJSONData()).toMatchObject({
			userName: request.body.userName,
		});
		expect(response._getJSONData().token).toBeDefined();
	});

	it('return 401 if user does not exist', async () => {
		const request = httpMocks.createRequest({
			userName: faker.name.firstName(),
			password: faker.internet.password(),
		});
		const response = httpMocks.createResponse();
		const next = jest.fn();

		jest
			.spyOn(userRepository, 'findUserByName')
			.mockImplementation(async () => undefined);

		await login(request, response, next);

		expect(response.statusCode).toBe(401);
	});

	it('return 401 if password does not match', async () => {
		const userName = faker.name.firstName();
		const actualPassword = faker.internet.password();
		const fakePassword = faker.internet.password();
		const user = {
			id: faker.datatype.number(),
			userName,
			password: actualPassword,
			name: faker.name.fullName(),
			contactNumbers: faker.phone.number(),
			email: faker.internet.email(),
		};
		const request = httpMocks.createRequest({
			userName,
			password: fakePassword,
		});
		const response = httpMocks.createResponse();
		const next = jest.fn();

		jest
			.spyOn(userRepository, 'findUserByName')
			.mockImplementation(async () => user);

		jest.spyOn(bcrypt, 'compare').mockImplementation(async () => false);

		await login(request, response, next);

		expect(response.statusCode).toBe(401);
	});

	it('delete a user', async () => {
		const request = httpMocks.createRequest();
		const response = httpMocks.createResponse();
		const next = jest.fn();

		jest
			.spyOn(userRepository, 'deleteUser')
			.mockImplementation(async () => undefined);

		await remove(request, response, next);

		expect(response.statusCode).toBe(204);
	});

	it('load a user information', async () => {
		const user = {
			id: faker.datatype.number(),
			userName: faker.name.fullName(),
			password: faker.internet.password(),
			name: faker.name.fullName(),
			contactNumbers: faker.phone.number(),
			email: faker.internet.email(),
		};
		const numOfReservationsOfUser = faker.datatype.number({ min: 0, max: 30 });
		const numOfInterestedCompaniesOfUser = faker.datatype.number({
			min: 0,
			max: 30,
		});
		const surveyArray = [
			{
				surveyId: faker.datatype.number(),
				bugId: faker.datatype.number(),
				bugName: faker.animal.insect(),
				surveyDate: faker.date.recent(3).toString(),
			},
			{
				surveyId: faker.datatype.number(),
				bugId: faker.datatype.number(),
				bugName: faker.animal.insect(),
				surveyDate: faker.date.recent(3).toString(),
			},
		];
		const productArray = [
			{
				productInterestId: faker.datatype.number(),
				productId: faker.datatype.number(),
				userId: faker.datatype.number(),
				productName: faker.commerce.productName(),
				thumbnail: faker.internet.url(),
				numOfInterestedUsers: faker.datatype.number({ min: 0, max: 30 }),
			},
			{
				productInterestId: faker.datatype.number(),
				productId: faker.datatype.number(),
				userId: faker.datatype.number(),
				productName: faker.commerce.productName(),
				thumbnail: faker.internet.url(),
				numOfInterestedUsers: faker.datatype.number({ min: 0, max: 30 }),
			},
		];
		const reservationArray = [
			{
				reservationId: faker.datatype.number(),
				userId: faker.datatype.number(),
				companyName: faker.company.name(),
				bugName: faker.animal.insect(),
				processState: faker.datatype.number({ min: 0, max: 3 }),
				reservationDateTime: faker.date.recent(3).toString(),
				visitDateTime: faker.date.soon(3).toString(),
			},
			{
				reservationId: faker.datatype.number(),
				userId: faker.datatype.number(),
				companyName: faker.company.name(),
				bugName: faker.animal.insect(),
				processState: faker.datatype.number({ min: 0, max: 3 }),
				reservationDateTime: faker.date.recent(3).toString(),
				visitDateTime: faker.date.soon(3).toString(),
			},
		];

		const request = httpMocks.createRequest();
		const response = httpMocks.createResponse();
		const next = jest.fn();

		jest
			.spyOn(userRepository, 'findUserById')
			.mockImplementation(async () => user);

		jest
			.spyOn(companiesRepository, 'getNumberOfReservationsOfUser')
			.mockImplementation(async () => numOfReservationsOfUser);

		jest
			.spyOn(companiesRepository, 'getNumberOfInterestedCompaniesOfUser')
			.mockImplementation(async () => numOfInterestedCompaniesOfUser);

		jest
			.spyOn(bugsRepository, 'getSurveyItemsOfUser')
			.mockImplementation(async () => surveyArray);

		jest
			.spyOn(productsRepository, 'getProductItemsOfUser')
			.mockImplementation(async () => productArray);

		jest
			.spyOn(companiesRepository, 'getReservationItemsOfUser')
			.mockImplementation(async () => reservationArray);

		await getMyPage(request, response, next);

		const userDetail = {
			...user,
			accumulatedNumOfUsages: numOfReservationsOfUser,
			numberOfInterestedCompanies: numOfInterestedCompaniesOfUser,
			surveyList: surveyArray,
			updatedProductList: productArray,
			reservationList: reservationArray,
		};

		expect(response.statusCode).toBe(200);
		expect(response._getJSONData()).toMatchObject(userDetail);
	});
});
```

ìœ ë‹›í…ŒìŠ¤íŠ¸ì˜ ëŒ€ìƒì´ ë˜ëŠ” ì»¨íŠ¸ë¡¤ëŸ¬ í•¨ìˆ˜ì¸ createUser, getMyPage, login, removeë¥¼ ëª¨ë‘ import í•´ì™”ë‹¤. user.tsì—ì„œ ë‚´ë¶€ì ìœ¼ë¡œ ì˜ì¡´í•˜ê³  ìˆëŠ” ì™¸ë¶€ ëª¨ë“ˆë“¤ ì—­ì‹œ import í•˜ëŠ” ë™ì‹œì— jest.mock(ê²½ë¡œëª…)ì„ í†µí•´ ëª¨ë“ˆ ì „ì²´ë¥¼ mocking í•  ê±°ë¼ê³  ì„ ì–¸í•´ì£¼ê³  jest.spyOn(ë ˆí¬ì§€í† ë¦¬ëª…, 'API ëª…').mockImplementation(...)ì„ í†µí•´ í•¨ìˆ˜ì˜ êµ¬í˜„ ì‚¬í•­ì„ mocking í–ˆë‹¤. ê·¸ëŸ¬ë‚˜ ìœ„ì˜ ì½”ë“œë“¤ì€ ëª¨ë“ˆ ê°„ ì˜ì¡´ì„±ì´ ê°•í•˜ê³  í…ŒìŠ¤íŠ¸ êµ¬í˜„ì´ ë³µì¡í•˜ë‹¤ëŠ” ë‹¨ì ì´ ìˆë‹¤. ë”°ë¼ì„œ ì¸íŠ¸ë¡œì—ì„œ ì–¸ê¸‰í–ˆë“¯ì´ stubì˜ ë°©ì‹ì„ í†µí•´ ë¦¬íŒ©í† ë§ í•´ë³´ì•˜ë‹¤.

**/src/controller/user.ts (refactoring version ğŸª„)**

```javascript
import { Request, Response, NextFunction } from 'express';
import bcrypt from 'bcrypt';
import jwt from 'jsonwebtoken';
import { config } from '../config.js';
import { UserRegistration, UserLogin, ProductItem, UserRepository, ProductRepository, BugRepository, CompanyRepository } from '../types/index.js';

export default class UserController {
	userRepository: UserRepository;
	productRepository: ProductRepository;
	bugRepository: BugRepository;
	companyRepository: CompanyRepository;

	constructor(userRepository: UserRepository, productRepository: ProductRepository, bugRepository: BugRepository, companyRepository: CompanyRepository) {
		this.userRepository = userRepository;
		this.productRepository = productRepository;
		this.bugRepository = bugRepository;
		this.companyRepository = companyRepository;
	}

	createUser = async (req: Request, res: Response, next: NextFunction) => {
		const { userName, password } = req.body as UserRegistration;
		const user = await this.userRepository.findUserByName(userName);
		if (user) {
			return res.sendStatus(409);
		}

		const hashed = await bcrypt.hash(
			password,
			parseInt(config.bcrypt.saltsRound)
		);
		const userId = await this.userRepository.createUser({
			...req.body,
			password: hashed,
		});

		const token = this.createJWT(userId);

		res.status(201).json({
			token,
			userName,
		});
	};

	login = async (req: Request, res: Response, next: NextFunction) => {
		const { userName, password } = req.body as UserLogin;
		const user = await this.userRepository.findUserByName(userName);
		if (!user) return res.sendStatus(401);

		const match = await bcrypt.compare(password, user.password);
		if (!match) return res.sendStatus(401);

		const token = this.createJWT(user.id);

		res.status(200).json({
			token,
			userName,
		});
	};

	remove = async (req: Request, res: Response, next: NextFunction) => {
		await this.userRepository.deleteUser(req.userId!);
		res.sendStatus(204);
	};

	getMyPage = async (req: Request, res: Response, next: NextFunction) => {
		const { findUserById } = this.userRepository;
		const {
			getNumberOfReservationsOfUser,
			getNumberOfInterestedCompaniesOfUser,
			getReservationItemsOfUser,
		} = this.companyRepository;
		const { getSurveyItemsOfUser } = this.bugRepository;
		const { getProductItemsOfUser } = this.productRepository;

		const user = await findUserById(req.userId!);
		const accumulatedNumOfUsages = await getNumberOfReservationsOfUser(
			req.userId!
		);
		const numberOfInterestedCompanies =
			await getNumberOfInterestedCompaniesOfUser(req.userId!);
		const surveyList = await getSurveyItemsOfUser(req.userId!);
		const productList = await getProductItemsOfUser(req.userId!);
		const reservationList = await getReservationItemsOfUser(req.userId!);

		let updatedProductList;
		await Promise.all(
			productList.map(async (product) => {
				return this.updateNumOfInterestedUsers(product);
			})
		).then((result) => (updatedProductList = result));

		const userDetail = {
			...user,
			accumulatedNumOfUsages,
			numberOfInterestedCompanies,
			surveyList,
			updatedProductList,
			reservationList,
		};

		res.status(200).json(userDetail);
	};

	private createJWT = (userId: number): string => {
		return jwt.sign({ userId }, config.jwt.privateKey, {
			expiresIn: config.jwt.expirSecs,
		});
	};

	private updateNumOfInterestedUsers = async (
		product: ProductItem
	): Promise<ProductItem> => {
		const numOfUsers =
			await this.productRepository.getNumberOfInterestedUsersOfProduct(
				product.productId.toString()
			);
		product.numOfInterestedUsers = numOfUsers;
		return product;
	};
}
```

ê¸°ì¡´ì— exportí–ˆë˜ í•¨ìˆ˜ë“¤ì„ UserController í´ë˜ìŠ¤ ì•ˆì— í¬í•¨ì‹œì¼œ í´ë˜ìŠ¤ ìì²´ë¥¼ defaultë¡œ exportí–ˆë‹¤. í´ë˜ìŠ¤ê°€ ì™¸ë¶€ë¡œë¶€í„° ë„¤ ê°œì˜ ë ˆí¬ì§€í† ë¦¬ ê°ì²´ë¥¼ ì£¼ì…ë°›ì•„ì•¼ í•˜ëŠ”ë°, ê°ê°ì˜ ë ˆí¬ì§€í† ë¦¬ ì¸í„°í˜ì´ìŠ¤ë¥¼ ë”°ë¡œ ì •ì˜í•´ì£¼ì–´ì•¼ í•œë‹¤.

**/types/index.d.ts**

```javascript
...
export interface UserRepository {
	createUser(user: UserRegistration): Promise<number>;
	findUserById(userId: number): Promise<User>;
	findUserByName(userName: string): Promise<User>;
	deleteUser(userId: number): Promise<undefined>;
}

export interface ProductRepository {
	getProducts(): Promise<Product[]>;
	getProduct(productId: string): Promise<Product>;
	isProductInterested(userId: number, productId: string): Promise<number>;
	addProductInterest(userId: number, productId: string): Promise<number>;
	removeProductInterest(userId: number, productId: string): Promise<undefined>;
	getProductItemsOfUser(userId: number): Promise<ProductItem[]>;
	getNumberOfInterestedUsersOfProduct(productId: string): Promise<number>;
}

export interface CompanyRepository {
	getCompanies(): Promise<Company[]>;
	reserveCompany(
		userId: number,
		companyId: string,
		reservation: ReservationForm
	): Promise<number>;
	getReservationDetail(reservationId: string): Promise<ReservationDetail>;
	findCompanyById(companyId: string): Promise<Company>;
	isCompanyInterested(userId: number, companyId: string): Promise<number>;
	addCompanyInterest(userId: number, companyId: string): Promise<number>;
	removeCompanyInterest(userId: number, companyId: string): Promise<undefined>;
	getNumberOfReservationsOfUser(userId: number): Promise<number>;
	getNumberOfInterestedCompaniesOfUser(userId: number): Promise<number>;
	getNumberOfInterestedUsersOfCompany(companyId: string): Promise<number>;
	getReservationItemsOfUser(userId: number): Promise<ReservationItem[]>;
}

export interface BugRepository {
	getBugs(): Promise<Bug[]>;
	getBug(bugId: string): Promise<Bug>;
	addSurveyResult(userId: number, bugId: string): Promise<number>;
	getSurveyItemsOfUser(userId: number): Promise<SurveyItem[]>;
}
```

íƒ€ì…ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ì§€ì›í•˜ëŠ” typeê°€ ì—¬ëŸ¬ íƒ€ì…ì˜ ë°ì´í„°ë¥¼ í•˜ë‚˜ì˜ íƒ€ì…ìœ¼ë¡œ ì •ì˜í•  ë•Œ ì£¼ë¡œ ì‚¬ìš©ëœë‹¤ë©´ interfaceëŠ” ê·œê²©ì„ ì •ì˜í•˜ê³  ì´ì— ëŒ€í•´ êµ¬í˜„ì„ í•´ì•¼í•  ë•Œ ì‚¬ìš©ëœë‹¤. í¸ì˜ìƒ /types/index.d.tsì— í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•œ ì»¤ìŠ¤í…€ íƒ€ì…ê³¼ ì¸í„°í˜ì´ìŠ¤ë¥¼ ëª¨ë‘ í•œë²ˆì— ì •ì˜í•´ë‘ì—ˆë‹¤.


**/src/controller/test/user.test.ts (refactoring version ğŸª„)** 


```javascript
import httpMocks from 'node-mocks-http';
import { faker } from '@faker-js/faker';
import * as bcrypt from 'bcrypt';
import UserController from '../user';
import UserRepositoryImpl from './stub_user_repository_impl';
import BugRepositoryImpl from './stub_bug_repository_impl';
import CompanyRepositoryImpl from './stub_company_repository_impl';
import ProductRepositoryImpl from './stub_product_repository_impl';

jest.mock('bcrypt');

describe('User Controller', () => {
	let userRepository: UserRepositoryImpl;
	let productRepository: ProductRepositoryImpl;
	let companyRepository: CompanyRepositoryImpl;
	let bugRepository: BugRepositoryImpl;
	let userController: UserController;

	beforeEach(() => {
		userRepository = new UserRepositoryImpl();
		productRepository = new ProductRepositoryImpl();
		companyRepository = new CompanyRepositoryImpl();
		bugRepository = new BugRepositoryImpl();
		userController = new UserController(
			userRepository,
			productRepository,
			bugRepository,
			companyRepository
		);
	});

	it('create user', async () => {
		const registrationForm = userRepository.registrationForm;
		const request = httpMocks.createRequest({
			body: registrationForm,
		});
		const response = httpMocks.createResponse();
		const next = jest.fn();
		userRepository.findUserByName = jest
			.fn()
			.mockImplementation(() => undefined);

		await userController.createUser(request, response, next);

		expect(response.statusCode).toBe(201);
		expect(response._getJSONData()).toMatchObject({
			userName: request.body.userName,
		});
		expect(response._getJSONData().token).toBeDefined();
	});

	it('return 409 if user already exists', async () => {
		const registrationForm = userRepository.registrationForm;

		const request = httpMocks.createRequest({
			body: registrationForm,
		});
		const response = httpMocks.createResponse();
		const next = jest.fn();

		await userController.createUser(request, response, next);

		expect(response.statusCode).toBe(409);
	});

	it('succeed to login', async () => {
		const loginInfo = userRepository.loginInfo;

		const request = httpMocks.createRequest({
			body: loginInfo,
		});
		const response = httpMocks.createResponse();
		const next = jest.fn();

		jest.spyOn(bcrypt, 'compare').mockImplementation(async () => true);

		await userController.login(request, response, next);

		expect(response.statusCode).toBe(200);
		expect(response._getJSONData()).toMatchObject({
			userName: request.body.userName,
		});
		expect(response._getJSONData().token).toBeDefined();
	});

	it('return 401 if user does not exist', async () => {
		const loginInfo = userRepository.loginInfo;
		const request = httpMocks.createRequest({
			body: loginInfo,
		});
		const response = httpMocks.createResponse();
		const next = jest.fn();
		userRepository.findUserByName = jest
			.fn()
			.mockImplementation(() => undefined);

		await userController.login(request, response, next);

		expect(response.statusCode).toBe(401);
	});

	it('return 401 if password does not match', async () => {
		const loginInfo = userRepository.loginInfo;
		const request = httpMocks.createRequest({ body: loginInfo });
		const response = httpMocks.createResponse();
		const next = jest.fn();

		jest.spyOn(bcrypt, 'compare').mockImplementation(async () => false);

		await userController.login(request, response, next);

		expect(response.statusCode).toBe(401);
	});

	it('delete a user', async () => {
		const request = httpMocks.createRequest();
		const response = httpMocks.createResponse();
		const next = jest.fn();

		await userController.remove(request, response, next);

		expect(response.statusCode).toBe(204);
	});

	it('load a user information', async () => {
		const user = userRepository.fakeUser;
		const numOfReservationsOfUser = faker.datatype.number({ min: 0, max: 30 });
		const numOfInterestedCompaniesOfUser = faker.datatype.number({
			min: 0,
			max: 30,
		});
		const surveyArray = bugRepository.surveyItemArray;
		const productArray = productRepository.productItemArray;
		const reservationArray = companyRepository.reservationItemArray;

		const request = httpMocks.createRequest();
		const response = httpMocks.createResponse();
		const next = jest.fn();

		companyRepository.getNumberOfReservationsOfUser = jest
			.fn()
			.mockImplementation(() => numOfReservationsOfUser);
		companyRepository.getNumberOfInterestedCompaniesOfUser = jest
			.fn()
			.mockImplementation(() => numOfInterestedCompaniesOfUser);

		await userController.getMyPage(request, response, next);

		const userDetail = {
			...user,
			accumulatedNumOfUsages: numOfReservationsOfUser,
			numberOfInterestedCompanies: numOfInterestedCompaniesOfUser,
			surveyList: surveyArray,
			updatedProductList: productArray,
			reservationList: reservationArray,
		};

		expect(response.statusCode).toBe(200);
		expect(response._getJSONData()).toMatchObject(userDetail);
	});
});
```

ì´ì œëŠ” ëª¨ë“ˆ ì „ì²´ë¥¼ mocking í•˜ì§€ ì•Šê³  ê°™ì€ test í´ë” ë‚´ì— stub ìš©ìœ¼ë¡œ ë§Œë“¤ì–´ë‘” RepositoryImpl ê°ì²´ë¥¼ import í•´ì˜¤ê³  í•„ìš”í•œ ë¶€ë¶„ë§Œ mocking í•  ìˆ˜ ìˆë„ë¡ í•´ì£¼ì–´ ì½”ë“œì˜ ì–‘ì´ í›¨ì”¬ ì¤„ì–´ë“¤ì—ˆë‹¤. ê° ë‹¨ìœ„ í…ŒìŠ¤íŠ¸ ì´ì „ë§ˆë‹¤ ê°ì²´ë“¤ì„ ìƒˆë¡œ ìƒì„±í•´ì£¼ëŠ” ì´ìœ ëŠ” ê° í…ŒìŠ¤íŠ¸ë³„ë¡œ ë…ë¦½ì„±ì„ ìœ ì§€í•˜ê¸° ìœ„í•´ì„œì´ë‹¤. ë…ë¦½ì„±ì´ ìœ ì§€ëœë‹¤ë©´ ì´ì „ í…ŒìŠ¤íŠ¸ì—ì„œ ì½”ë“œì˜ ì¼ë¶€ë¥¼ mocking í–ˆì„ ì§€ë¼ë„ ë‹¤ìŒ í…ŒìŠ¤íŠ¸ì—ì„œëŠ” Stub classì˜ êµ¬í˜„ì‚¬í•­ì´ ê·¸ëŒ€ë¡œ ì ìš©ë  ìˆ˜ ìˆë‹¤.

## Integration test

í†µí•© í…ŒìŠ¤ëŠ” ì„œë²„ë¥¼ ì‹¤ì œë¡œ êµ¬ë™ì‹œì¼œì„œ axiosë¥¼ ì´ìš©í•´ ì„œë²„ì— ìš”ì²­ì„ í•˜ê³  ì‘ë‹µì„ ë°›ì•„ì˜´ìœ¼ë¡œì¨ ì´ì „ì— ê²€ì¦ëœ ë‹¨ìœ„ë“¤ì˜ ìƒí˜¸ì‘ìš©ì„ í…ŒìŠ¤íŠ¸í•˜ëŠ” ê²ƒì´ë‹¤. ì„œë²„ë¥¼ ìˆ˜ë™ì ìœ¼ë¡œ ì‹œì‘ ë° ì¢…ë£Œì‹œí‚¤ê¸° ìœ„í•œ ì‘ì—…, ê°ê°ì˜ í†µí•© í…ŒìŠ¤íŠ¸ ì‹œ êµ¬ë™ë˜ëŠ” ì„œë²„ì˜ í¬íŠ¸ê°€ ì¶©ëŒí•˜ì§€ ì•Šë„ë¡ í•´ì£¼ëŠ” ì‘ì—…, ê·¸ë¦¬ê³  ëª¨ë“  í†µí•© í…ŒìŠ¤íŠ¸ë¥¼ ë§ˆì¹œ ë’¤ dbì˜ users í…Œì´ë¸”ì„ ì •ë¦¬í•´ì£¼ëŠ” ì‘ì—…ì„ ë³„ë„ë¡œ í•´ì£¼ì—ˆë‹¤. ë‹¨ìˆœì„±ì„ ìœ„í•´ User APIì™€ ê´€ë ¨í•´ì„œëŠ” íšŒì›ê°€ì…ê³¼ ë¡œê·¸ì¸, Products APIì™€ ê´€ë ¨í•´ì„œëŠ” ìƒí’ˆ ëª©ë¡ê³¼ ìƒí’ˆ ì•„ì´í…œ ë¶ˆëŸ¬ì˜¤ê¸° ê¸°ëŠ¥ë§Œ í†µí•© í…ŒìŠ¤íŠ¸í•˜ì˜€ë‹¤. Companies API, Bugs APIëŠ” ë”°ë¡œ í…ŒìŠ¤íŠ¸í•˜ì§€ ì•Šì•˜ë‹¤. ë”°ë¼ì„œ ìƒˆë¡œìš´ ì‚¬ìš©ì ê³„ì •ì„ ë§Œë“¤ ë•Œë§ˆë‹¤ ë°ì´í„°ë² ì´ìŠ¤ì— í…ŒìŠ¤íŠ¸ìš© ìœ ì € ì •ë³´ê°€ ë¶ˆí•„ìš”í•˜ê²Œ ì‚½ì…ë˜ë¯€ë¡œ global teardown ì‘ì—… ì‹œ ìœ ì € í…Œì´ë¸”ì˜ row ë“¤ì„ ëª¨ë‘ ì‚­ì œí•˜ê²Œë” ì²˜ë¦¬í•´ì£¼ì—ˆë‹¤.

**/src/app.ts**

```javascript
import express from 'express';
import { Request, Response, NextFunction } from 'express';
import yamljs from 'yamljs';
import morgan from 'morgan';
import swaggerUi from 'swagger-ui-express';
import { Server } from 'http';
import BugsRouter from './routes/bugs.js';
import UserRouter from './routes/user.js';
import CompaniesRouter from './routes/companies.js';
import ProductsRouter from './routes/products.js';
import { pool } from './db/database.js';

const app = express();

const apiJSDocument = yamljs.load('./api/openapi.yaml');

export const startServer = (port: number) => {
	app.use(express.json());
	app.use(morgan('tiny'));
	app.use('/api-docs', swaggerUi.serve, swaggerUi.setup(apiJSDocument));

	app.use('/user', UserRouter);
	app.use('/bugs', BugsRouter);
	app.use('/companies', CompaniesRouter);
	app.use('/products', ProductsRouter);

	app.use('/', (req: Request, res: Response, next: NextFunction) => {
		res.sendStatus(404);
	});

	app.use((err: Error, req: Request, res: Response, next: NextFunction) => {
		if (err) {
			console.log(err);
			res.status(500).send('Internal Server Error...');
		}
	});

	let server: Server;
	server = app.listen(port);

	console.log('Server started...');
	return server;
};

export const stopServer = async (server: Server) => {
	return new Promise(async (resolve, reject) => {
		server.close((error) => {
			if (error) reject(error);
			try {
				pool.end();
			} catch (error) {
				reject(error);
			}
			resolve(null);
		});
	});
};
```

**/src/index.ts**

```javascript
import { startServer } from './app.js';
import { config } from './config.js';

try {
	startServer(config.host.port);
} catch (error) {
	console.log('Cannot start server...');
}
```

startServer í•¨ìˆ˜ëŠ” ì¸ìë¡œ ë°›ì€ íŠ¹ì • í¬íŠ¸ì—ì„œ êµ¬ë™ë˜ëŠ” ì„œë²„ ê°ì²´ë¥¼ ë°˜í™˜í•˜ê²Œ í•´ì£¼ì—ˆê³  stopServerëŠ” serverì™€ì˜ ì—°ê²°ì„ ë¹„ë™ê¸°ì ìœ¼ë¡œ ëŠê³  ì´ ê³¼ì •ì—ì„œ ì—ëŸ¬ê°€ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤ë©´ ë°ì´í„°ë² ì´ìŠ¤ poolê³¼ì˜ ì—°ê²°ë„ ëŠê²Œ í•´ì£¼ì—ˆë‹¤. ì •ì˜ëœ ë‘ í•¨ìˆ˜ë¥¼ ì´ìš©í•˜ì—¬ production ëª¨ë“œì—ì„œëŠ” ë©”ì¸ entryë¥¼ index.jsë¡œ í•´ì£¼ì–´ íŒŒì¼ ë‚´ë¶€ì—ì„œ startServer í˜¸ì¸¨ì„ í†µí•´ ì„œë²„ë¥¼ ìˆ˜ë™ì ìœ¼ë¡œ ì‹œì‘í•˜ê²Œ í•´ì£¼ì—ˆë‹¤.

**/src/tests/user.test.ts**

```javascript
import axios, { AxiosInstance } from 'axios';
import { faker } from '@faker-js/faker';
import { startServer, stopServer } from '../app.js';
import { Server } from 'http';
import { AddressInfo } from 'net';
import { createNewAccount, createUserDetails } from './auth_utils.js';

describe('User APIs', () => {
	let server: Server;
	let request: AxiosInstance;

	beforeAll(() => {
		server = startServer(0);
		const address = server.address() as AddressInfo;
		request = axios.create({
			baseURL: `http://localhost:${address.port}`,
			validateStatus: null,
		});
	});

	afterAll(async () => {
		await stopServer(server);
	});

	it('POST /signup', async () => {
		const registrationForm = createUserDetails();
		const response = await request.post('/user/signup', registrationForm);

		expect(response.status).toBe(201);
		expect(response.data.token).toBeDefined();
		expect(response.data.userName).toEqual(registrationForm.userName);
	});

	it('POST /login', async () => {
		const user = await createNewAccount(request);
		const loginInFo = { userName: user.userName, password: user.password };
		const response = await request.post('/user/login', loginInFo);

		expect(response.status).toBe(200);
		expect(response.data.token).toBeDefined();
		expect(response.data.userName).toEqual(loginInFo.userName);
	});

	it('return 401 if user is not registered', async () => {
		const randomUserName = faker.name.firstName();
		const randomPassword = faker.internet.password();
		const loginInfo = { userName: randomUserName, password: randomPassword };
		const response = await request.post('/user/login', loginInfo);

		expect(response.status).toBe(401);
	})

	it('return 401 if password does not match', async() => {
		const user = await createNewAccount(request);
		const fakePassword= user.password.toUpperCase();
		const loginInfo = { userName: user.userName, password: fakePassword };
		const response = await request.post('/user/login', loginInfo);

		expect(response.status).toBe(401);
	})
});
```

**/src/tests/auth_utils.ts**

```javascript
import { faker } from '@faker-js/faker';
import { AxiosInstance } from 'axios';

export async function createNewAccount(request: AxiosInstance) {
	const userDetails = createUserDetails();
	const response = await request.post('/user/signup', userDetails);

	return {
		...userDetails,
		token: response.data.token,
	};
}

export function createUserDetails() {
	return {
		userName: faker.name.firstName(),
		password: faker.internet.password(),
		name: faker.name.middleName(),
		contactNumbers: faker.phone.number(),
		email: faker.internet.email(),
	};
}
```

test ëª¨ë“œì—ì„œëŠ” beforeAllì—ì„œ startServer í˜¸ì¶œì„ í†µí•´ ì„œë²„ë¥¼ ìˆ˜ë™ì ìœ¼ë¡œ ì‹œì‘í•˜ê²Œ í•´ì¤€ ë‹¤ìŒ afterAllì—ì„œ stopServer í˜¸ì¶œì„ í†µí•´ ì„œë²„ì™€ì˜ ì—°ê²°ì„ ëŠê²Œ í•´ì£¼ì—ˆë‹¤. ì´ë•Œ í…ŒìŠ¤íŠ¸ ëª¨ë“œì—ì„œ startServerì˜ ì¸ìë¡œ í¬íŠ¸ ë²ˆí˜¸ 0ì„ ë„˜ê²¨ì£¼ë©´ ìš´ì˜ ì²´ì œê°€ ì•Œì•„ì„œ í˜„ì¬ ì‚¬ìš©ë˜ê³  ìˆì§€ ì•Šì€ í¬íŠ¸ë¥¼ í• ë‹¹í•˜ê²Œ í•´ì£¼ê¸° ë•Œë¬¸ì— í…ŒìŠ¤íŠ¸ë¥¼ ë³‘ë ¬ì ìœ¼ë¡œ ì‹¤í–‰ì‹œí‚¬ ë•Œ ì¶©ëŒì´ ë°œìƒí•˜ì§€ ì•ŠëŠ”ë‹¤. ê·¸ë¦¬ê³  ë°˜í™˜ëœ serverì˜ addressì— ì ‘ê·¼í•´ port ë²ˆí˜¸ë¥¼ ì•Œì•„ì˜¤ë©´ base urlê³¼ í•¨ê»˜ axiosì˜ ì¸ìŠ¤í„´ìŠ¤ë¥¼ ìƒì„±í•  ìˆ˜ ìˆë‹¤. ì´ ì¸ìŠ¤í„´ìŠ¤ëŠ” ì´í›„ POST, GET ìš”ì²­ì„ í•´ì„œ ì‘ë‹µì„ ë°˜í™˜í•  ìˆ˜ ìˆë‹¤. Products APIë“¤ì„ í…ŒìŠ¤íŠ¸í•  ë•Œ ìš”ì²­ ì‹œ tokenì„ í—¤ë”ì— í¬í•¨ì‹œì¼œ ë³´ë‚´ì•¼ í•˜ë¯€ë¡œ ì´ì „ì— íšŒì›ê°€ì…ì„ í†µí•´ ë°›ì•„ì˜¨ token ì •ë³´ë¥¼ ë°›ì•„ ì˜¬ í•„ìš”ê°€ ìˆê¸° ë•Œë¬¸ì— createNewAccount() í•¨ìˆ˜ë¥¼ ë‘ ê¸°ëŠ¥ì˜ í…ŒìŠ¤íŠ¸ì—ì„œ ëª¨ë‘ ì‚¬ìš©í•  ìˆ˜ ìˆë„ë¡ ìœ í‹¸ë¦¬í‹° í•¨ìˆ˜ë¡œ ë”°ë¡œ ë¹¼ë‘ì—ˆë‹¤. íšŒì›ê°€ì… ì •ë³´ë¥¼ ìƒì„±í•˜ëŠ” createUserDetails() ì—­ì‹œ í…ŒìŠ¤íŠ¸ì‹œ í•„ìš”ë¡œ í•˜ë¯€ë¡œ export ë˜ë„ë¡ í•˜ì˜€ë‹¤.

**/src/tests/products.test.ts**

```javascript
import axios, { AxiosInstance } from 'axios';
import { Server } from 'http';
import { AddressInfo } from 'net';
import { faker } from '@faker-js/faker';
import { createNewAccount } from './auth_utils';
import { startServer, stopServer } from '../app';

describe('Products APIs', () => {
	let server: Server;
	let request: AxiosInstance;

	beforeAll(() => {
		server = startServer(0);
		const address = server.address() as AddressInfo;
		request = axios.create({
			baseURL: `http://localhost:${address.port}`,
			validateStatus: null,
		});
	});

	afterAll(async () => {
		await stopServer(server);
	});

	it('GET /products', async () => {
		const user = await createNewAccount(request);
		const response = await request.get('/products', {
			headers: {
				Authorization: `Bearer ${user.token}`,
			},
		});

		expect(response.status).toBe(200);
		expect(response.data.length).toBeGreaterThan(0);
	});

	it('GET /products/:product_id', async () => {
		const user = await createNewAccount(request);
        const productId = 1;
		const response = await request.get(`/products/${productId}`, {
			headers: {
				Authorization: `Bearer ${user.token}`,
			},
		});

		expect(response.status).toBe(200);
		expect(response.data).toBeDefined();
	});

	it('return 404 with invalid product id', async () => {
		const user = await createNewAccount(request);
        const fakeProductId = faker.datatype.number({ min: 10000 });
		const response = await request.get(`/products/${fakeProductId}`, {
			headers: {
				Authorization: `Bearer ${user.token}`,
			},
		});

		expect(response.status).toBe(404);
	});
});
```

ìƒí’ˆ ëª©ë¡ í˜¹ì€ ì•„ì´í…œì„ ë¶ˆëŸ¬ì˜¤ëŠ” GET ìš”ì²­ì„ í•  ë•Œ ë‘ë²ˆì§¸ ì¸ìì— íšŒì›ê°€ì…ì„ í•´ì„œ ë°›ì•„ì˜¨ í† í°ì„ í—¤ë”ì— í¬í•¨ì‹œí‚¤ëŠ” ì‘ì—…ì„ ì²˜ë¦¬í•´ì£¼ì—ˆë‹¤.

**src/tests/global_teardown.ts**

```javascript
import mysql from 'mysql';
import dotenv from 'dotenv';
import path from 'path';

dotenv.config({ path: path.resolve(__dirname, '../../.env.test') });

export default async function teardown() {
	return new Promise((resolve, reject) => {
		const pool = mysql.createPool({
			host: process.env['DB_HOST'],
			user: process.env['DB_USER'],
			password: process.env['DB_PASSWORD'],
			database: process.env['DB_DATABASE'],
		});

		pool.query('DELETE FROM users', (error) => {
			if (error) {
				console.log(error);
				reject(error);
			}
			console.log('DB is cleared');
			resolve(null);
		});
	});
}
```

global_teardown.ts íŒŒì¼ì—ì„œëŠ” ë°˜ë“œì‹œ í•˜ë‚˜ì˜ í•¨ìˆ˜ë¥¼ defaultë¡œ exportí•˜ê³  dbì— ì ‘ê·¼í•˜ëŠ” ì½”ë“œê°€ ë¹„ë™ê¸°ì ìœ¼ë¡œ ì‹¤í–‰ë  ìˆ˜ ìˆë„ë¡ Promise ë‚´ë¶€ì— êµ¬í˜„í•´ì£¼ì—ˆë‹¤. ì „ì—­ìœ¼ë¡œ ì¸ì‹ë˜ëŠ” íŒŒì¼ì˜ ê²½ìš° ì–´í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©í•˜ëŠ” ëª¨ë“ˆì„ import í•´ì˜¬ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ ë°ì´í„°ë² ì´ìŠ¤ poolì„ ë‹¤ì‹œ ìƒì„±í•´ì£¼ì–´ì•¼ í•œë‹¤. ê·¸ë¦¬ê³  package.jsonì˜ scripts ëª…ë ¹ì–´ì— í†µí•© í…ŒìŠ¤íŠ¸ í˜¹ì€ ì „ì²´ í…ŒìŠ¤íŠ¸ë¥¼ ì‹¤í–‰í•˜ê³  ë‚œ ë’¤ tear down ì‘ì—…ì´ ë  ìˆ˜ ìˆë„ë¡ ëª…ë ¹ì–´ë¥¼ ì¶”ê°€í•´ì£¼ê¸°ë§Œ í•˜ë©´ ëœë‹¤. ì‚¬ì‹¤ ì´ëŸ¬í•œ í…ŒìŠ¤íŠ¸ë¥¼ í•  ë•Œë§ˆë‹¤ ê¸°ì¡´ì˜ ìœ íš¨í•œ User í…Œì´ë¸”ì˜ íšŒì› ì •ë³´ë“¤ì´ ëª¨ë‘ ì‚¬ë¼ì§„ë‹¤ëŠ” ì ì—ì„œ ì´ëŠ” ì¢‹ì€ ì½”ë“œë¼ê³  í•  ìˆ˜ ì—†ë‹¤. ì´ëŸ° ì‹ìœ¼ë¡œ global teardown ì‘ì—…ì„ ìˆ˜ë™ì ìœ¼ë¡œ í•´ì£¼ëŠ” ê²ƒ ë§ê³  ë„ì»¤ë¥¼ ì‚¬ìš©í•˜ë©´ ê°œë³„ í™˜ê²½ì—ì„œ dbì™€ ê´€ë ¨ëœ ì‘ì—…ì„ í…ŒìŠ¤íŠ¸í•  ìˆ˜ ìˆë‹¤ê³  í•œë‹¤. ë‹¤ìŒ í”„ë¡œì íŠ¸ì—ì„œëŠ” ê¼­ ë„ì»¤ë¥¼ ì ìš©í•  ìˆ˜ ìˆë„ë¡ ë” ê³µë¶€í•´ì•¼ê² ë‹¤.
